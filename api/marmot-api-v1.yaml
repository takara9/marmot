openapi: "3.0.3"
info:
  version: 0.0.5
  title: REST API of Marmot Server
servers:
  - url: http://0.0.0.0:{port}{basePath}
    description: Marmot Server API
    variables:
      port:
        enum:
          - "8080"
        default: "8080"
      basePath:
        default: /api/v1
        description: Base path for the API
tags:
  - name: user
  - name: version
paths:
  /version:
    get:
      summary: "Get Version"
      operationId: getVersion
      tags:
        - version
      responses:
        "200":
          description: Get Marmot Server Version
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Version"
  /ping:
    get:
      summary: "Alive"
      operationId: replyPing
      tags:
        - alive
      responses:
        "200":
          description: Check Marmot Server is Alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReplyMessage"
  /hypervisors:
    get:
      summary: "List Hypervisors"
      operationId: listHypervisors
      tags:
        - hypervisor
      parameters:
        - name: limit
          in: query
          description: How many items to return at one time (max 100)
          required: false
          schema:
            type: integer
            maximum: 10
            format: int32
      responses:
        "200":
          description: List of Hypervisors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Hypervisors"
  /virtualMachines:
    get:
      summary: "List Virtual Machines"
      operationId: listVirtualMachines
      tags:
        - virtual-machine
      responses:
        "200":
          description: List of Virtual Machines
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/virtualMachines"
  /createCluster:
    post:
      summary: "Create Cluster of Virtual Machines"
      operationId: createCluster
      tags:
        - virtual-machine
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MarmotConfig"
      responses:
        "201":
          description: Created the Cluster
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /destroyCluster:
    post:
      summary: "Destroy Cluster of Virtual Machines"
      operationId: destroyCluster
      tags:
        - virtual-machine
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MarmotConfig"
      responses:
        "200":
          description: Destroyed the Virtual Machines
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /stopCluster:
    post:
      summary: "Stop Cluster of Virtual Machines"
      operationId: stopCluster
      tags:
        - virtual-machine
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MarmotConfig"
      responses:
        "200":
          description: Stopped the Virtual Machines
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /startCluster:
    post:
      summary: "Start Cluster of Virtual Machines"
      operationId: startCluster
      tags:
        - virtual-machine
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MarmotConfig"
      responses:
        "200":
          description: Started the Virtual Machines
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /createVm:
    post:
      summary: "Create Virtual Machine"
      operationId: createVirtualMachine
      tags:
        - virtual-machine
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/vmSpec"
      responses:
        "200":
          description: Started the Virtual Machines
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /destroyVm:
    post:
      summary: "Destroy Virtual Machines"
      operationId: destroyVirtualMachine
      tags:
        - virtual-machine
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/vmSpec"
      responses:
        "200":
          description: Destroyed the Virtual Machines
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /stopVm:
    post:
      summary: "Stop Virtual Machines"
      operationId: stopVirtualMachine
      tags:
        - virtual-machine
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/vmSpec"
      responses:
        "200":
          description: Stopped the Virtual Machines
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /startVm:
    post:
      summary: "Start Virtual Machine"
      operationId: startVirtualMachine
      tags:
        - virtual-machine
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/vmSpec"
      responses:
        "200":
          description: Stopped the Virtual Machines
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /hypervisor/{hypervisorId}:
    get:
      summary: "Info for a specific hypervisor"
      operationId: showHypervisorById
      tags:
        - hypervisor
      parameters:
        - name: hypervisorId
          in: path
          required: true
          description: The id of the pet to retrieve
          schema:
            type: string
  /volume:
    post:
      summary: "Create Volume"
      operationId: createVolume
      tags:
        - storage
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Volume"
      responses:
        "200":
          description: Created the Volume
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      summary: "List Volumes"
      operationId: listVolumes
      tags:
        - storage
      responses:
        "200":
          description: List of Volumes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Volume"
  /volume/{volumeId}:
    get:
      summary: "Info for a specific volume"
      operationId: showVolumeById
      tags:
        - storage
      parameters:
        - name: volumeId
          in: path
          required: true
          description: The id of the volume to retrieve
          schema:
            type: string
    put:
      summary: "Update Volume"
      operationId: updateVolumeById
      tags:
        - storage
      parameters:
        - name: volumeId
          in: path
          required: true
          description: The id of the volume to update
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Volume"
      responses:
        "200":
          description: Updated the Volume
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: "Delete Volume"
      operationId: deleteVolumeById
      tags:
        - storage
      parameters:
        - name: volumeId
          in: path
          required: true
          description: The id of the volume to delete
          schema:
            type: string
      responses:
        "200":
          description: Deleted the Volume
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /server:
    post:
      summary: "Create Virtual Server"
      description: |
        Create a new virtual server. The virtual server specifications are specified in the request body.
        If the virtual server is successfully created, the information of the created virtual server is returned in the response.
        The virtual server is then automatically started.
        The virtual server specifications include CPU, memory, storage, network settings, and more.
        If an error occurs during virtual server creation, an appropriate error message is returned.
      operationId: createServer
      tags:
        - server
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Server"
      responses:
        "201":
          description: "Successfully created and started the virtual server."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        default:
          description: "An error occurred."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      summary: "Get Server Information"
      description: |
        Retrieve information about existing virtual servers. A list of virtual servers is returned in the response.
        Each virtual server's information includes server ID, status, resource usage, and more.
        If no virtual servers exist or an error occurs while retrieving information, an appropriate error message is returned.
      operationId: getServers
      tags:
        - server
      responses:
        "200":
          description: "Successfully retrieved the list of servers."
          content:
            application/json:
              schema:
                  $ref: "#/components/schemas/Servers"
        default:
          description: "An error occurred."
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /server/{id}:
      get:
        summary: "Get particular server Information"
        operationId: getServerById
        tags:
          - server
        parameters:
          - name: id
            in: path
            required: true
            description: The ID identifies the server.
            schema:
              type: string
        responses:
          "200":
            description: "Successfully retrieved the server information."
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/Server"
          default:
            description: "An error occurred."
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/Error"
      put:
        summary: "Update Server Information by Id"
        operationId: updateServerById
        tags:
          - server
        parameters:
          - name: id
            in: path
            required: true
            description: The id of the server to update
            schema:
              type: string
        requestBody:
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Server"
        responses:
          "200":
            description: Updated the Server
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/Success"
          default:
            description: unexpected error
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/Error"
      delete:
        summary: "Delete Server"
        operationId: deleteServerById
        tags:
          - server
        parameters:
          - name: id
            in: path
            required: true
            description: The id of the server to delete
            schema:
              type: string
        responses:
          "200":
            description: Deleted the Server
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/Success"
          default:
            description: unexpected error
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/Error"

components:
  schemas:
    Pong:
      type: object
      required:
        - ping
      properties:
        ping:
          type: string
          example: pong
    Version:
      type: object
      required:
        - clientVersion
      properties:
        serverVersion:
          type: string
        clientVersion:
          type: string
    Hypervisor:
      type: object
      required:
        - nodeName
        - cpu
      properties:
        nodeName:
          type: string
        cpu:
          type: integer
          format: int32
        memory:
          type: integer
          format: int64
        ipAddr:
          type: string
        port:
          type: integer
          format: int32
        freeCpu:
          type: integer
          format: int32
        freeMemory:
          type: integer
          format: int64
        key:
          type: string
        status:
          type: integer
          format: int32
        stgPool:
          type: array
          maxItems: 100
          items:
            $ref: "#/components/schemas/storagePool"
    storagePool:
      type: object
      properties:
        volGroup:
          type: string
        freeCap:
          type: integer
          format: int64
        vgCap:
          type: integer
          format: int64
        type:
          type: string
    Hypervisors:
      type: array
      maxItems: 100
      items:
        $ref: "#/components/schemas/Hypervisor"
    virtualMachines:
      type: array
      maxItems: 100
      items:
        $ref: "#/components/schemas/virtualMachine"
    virtualMachine:
      type: object
      required:
        - name
        - HvNode
      properties:
        name:
          type: string
        clusterName:
          type: string
        key:
          type: string
        uuid:
          type: string
        HvNode:
          type: string
        HvIpAddr:
          type: string
        HvPort:
          type: integer
          format: int32
        cTime:
          type: string
          format: date-time
        sTime:
          type: string
          format: date-time
        status:
          type: integer
          format: int32
        cpu:
          type: integer
          format: int32
        memory:
          type: integer
          format: int64
        privateIp:
          type: string
        publicIp:
          type: string
        storage:
          type: array
          maxItems: 100
          items:
            $ref: "#/components/schemas/storage"
        playbook:
          type: string
        comment:
          type: string
        osLv:
          type: string
        osVg:
          type: string
        osVariant:
          type: string
    storage:
      type: object
      properties:
        name:
          type: string
        size:
          type: integer
          format: int64
        path:
          type: string
        lv:
          type: string
        vg:
          type: string
        type:
          type: string
    MarmotConfig:
      type: object
      properties:
        domain:
          type: string
        cluster_name:
          type: string
        hypervisor:
          type: string
        imgae_template_path:
          type: string
        image_default_path:
          type: string
        qcow2_image:
          type: string
        os_variant:
          type: string
        private_ip_subnet:
          type: string
        public_ip_subnet:
          type: string
        net_dev_default:
          type: string
        net_dev_private:
          type: string
        net_dev_public:
          type: string
        public_ip_gw:
          type: string
        public_ip_dns:
          type: string
        vm_spec:
          type: array
          maxItems: 100
          items:
            $ref: "#/components/schemas/vmSpec"
    vmSpec:
      type: object
      properties:
        name:
          type: string
        cpu:
          type: integer
          format: int32
        memory:
          type: integer
          format: int64
        private_ip:
          type: string
        public_ip:
          type: string
        playbook:
          type: string
        comment:
          type: string
        uuid:
          type: string
        key:
          type: string
        ostempvg:
          type: string
        ostemplv:
          type: string
        ostempvariant:
          type: string
        storage:
          type: array
          maxItems: 100
          items:
            $ref: "#/components/schemas/storage"
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          format: int32
        message:
          type: string
    ReplyMessage:
      type: object
      properties:
        message:
          type: string
          example: "ok"
      required:
        - message
    Volume:
      type: object
      required:
        - id
      properties:
        id:
          type: string
        type:
          type: string
        kind:
          type: string
        key:
          type: string
        name:
          type: string
        volumeGroup:
          type: string
        logicalVolume:
          type: string
        size:
          type: integer
          format: int
        path:
          type: string
        status:
          type: integer
          format: int
        cTime:
          type: string
          format: date-time
        mTime:
          type: string
          format: date-time
        osVariant:
          type: string
        comment:
          type: string
        persistent:
          type: boolean
    Success:
      type: object
      required:
        - id
      properties:
        id:
          type: string
        message:
          type: string
    Network:
      type: object
      required:
        - id
      properties:
        id:
          type: string
        uuid:
          type: string
        networkname:
          type: string
        ethernet:
          type: string
        mac:
          type: string
        dhcp4:
          type: boolean
        dhcp6:
          type: boolean
        address:
          type: string
        netmask:
          type: string
        nameservers:
          type: object
          $ref: "#/components/schemas/Nameservers"
        routes:
          type: array
          maxItems: 6
          items:
            $ref: "#/components/schemas/Route"
        portgroup:
          type: string
        vlans:
          type: array
          maxItems: 4
          items:
            type: integer
            format: uint
    Nameservers:
      type: object
      properties:
        addresses:
          type: array
          maxItems: 4
          items:
            type: string
        search:
          type: array
          maxItems: 4
          items:
            type: string
    Route:
      type: object
      properties:
        to:
          type: string
        via:
          type: string
    Servers:
      type: array
      maxItems: 100
      items:
        $ref: "#/components/schemas/Server"
    Server:
      type: object
      required:
        - id
      properties:
        id:
          type: string
        uuid:
          type: string
        name:
          type: string
        instanceName:
          type: string
        clusterName:
          type: string
        key:
          type: string
        HvNode:
          type: string
        HvIpAddr:
          type: string
        HvPort:
          type: integer
          format: int
        cTime:
          type: string
          format: date-time
        sTime:
          type: string
          format: date-time
        status:
          type: integer
          format: int
        cpu:
          type: integer
          format: int
        memory:
          type: integer
          format: int
        Network:
          type: array
          maxItems: 10
          items:
            $ref: "#/components/schemas/Network"
        Storage:
          type: array
          maxItems: 10
          items:
            $ref: "#/components/schemas/Volume"
        playbook:
          type: string
        comment:
          type: string
        osLv:
          type: string
        osVg:
          type: string
        osVariant:
          type: string
        bootVolume:
          $ref: "#/components/schemas/Volume"